/**
 * Plugin Mobile for Roundcube
 * 
 * Add new skin mobile to Roundcube
 * 
 * Javascript mobile file
 * 
 * Copyright (C) 2015 PNE Annuaire et Messagerie/MEDDE
 * 
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author PNE Annuaire et Messagerie/MEDDE
 * @license GNU GPLv3+
 * 
 */
 // Fixed for jQuery 3.

 function add_mobile_class(e,t){var i=$(document.createElement("span")),a=$(t.obj),n=a.find("span.mobile_text");if(n.addClass(a.find("span.mobile_class").text()),i.text(n.text()),n.html(""),n.append(i),rcmail.env.showcontactsphotos){var o=$(document.createElement("img"));o.hide().on("load",function(){$(this).show(),n.find("span").hide()}).on("error",function(){$(this).hide()}).attr("src",rcmail.env.contactphotourl+"&_error=1&_email="+a.find("span.rcmContactAddress").attr("title")),n.append(o)}}function load_next_page(){var e=window.current_page_scroll;if(e>0&&e<=rcmail.env.pagecount&&!window.page_loading[e]){window.page_loading[e]=!0;var t=rcmail.set_busy(!0,"loading"),i={};i._mbox=rcmail.env.mailbox,i._page=e,rcmail.env.search_request&&(i._search=rcmail.env.search_request),rcmail.http_request("list",i,t)}}function show_uploadform(){var e=$("#upload-dialog");e.is(":visible")?e.dialog("close"):("compose"!=rcmail.env.action||e.data("extended")||($("<a>").addClass("iconlink add").attr("href","#add").html("Add").appendTo($('input[type="file"]',e).parent()).click(add_uploadfile),e.data("extended",!0)),e.dialog({modal:!0,resizable:!1,closeOnEscape:!0,title:e.attr("title"),close:function(){try{$("#upload-dialog form").get(0).reset()}catch(e){}e.dialog("destroy").hide(),$("div.addline",e).remove()},width:480}).show(),document.all||$("input[type=file]",e).first().click())}function add_uploadfile(e){var t=$(this).parent(),i=t.clone().addClass("addline").insertAfter(t);i.children(".iconlink").click(add_uploadfile),i.children("input").val(""),document.all||$("input[type=file]",i).click()}function show_header_row(e,t){var i=$("#compose-"+e);if(!i.is(":visible"))return compose_headers[e]&&!t&&$("#_"+e).val(compose_headers[e]),i.show(),$("#"+e+"-link").hide(),!1}function hide_header_row(e){var t=$("#_"+e);return compose_headers[e]=t.val(),t.val(""),$("#compose-"+e).hide(),$("#"+e+"-link").show(),!1}function toggleFullScreen(){var e=window.document,t=e.documentElement,i=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen||t.msRequestFullscreen,a=e.exitFullscreen||e.mozCancelFullScreen||e.webkitExitFullscreen||e.msExitFullscreen;e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement?a.call(e):(i.call(t),setTimeout(function(){window.scrollTo(0,1)},100))}var page_loading,current_page_scroll,current_uid,previous_page,timer,show_timer,checkmail_timer,touchstart_timer,storePosition={topCoordinate:null};$(document).on("pagecreate",".jqm-calendar",function(){$(document).on("swipeleft swiperight","#calendar",function(e){"swipeleft"===e.type?$("#calendar").fullCalendar("next"):$("#calendar").fullCalendar("prev")}),$("html").keydown(function(e){37==e.which?$("#calendar").fullCalendar("prev"):39==e.which&&$("#calendar").fullCalendar("next")}),$(".jqm_calendar_previous").click(function(e){$("#calendar").fullCalendar("prev")}),$(".jqm_calendar_next").click(function(e){$("#calendar").fullCalendar("next")})}),$(document).on("pageshow",".jqm-compose",function(){$("#compose-subject").click(function(){$("#compose-subject input").focus()})}),$(document).on("pageshow","#page_mail_list",function(){null!==window.storePosition.topCoordinate&&$.mobile.silentScroll(window.storePosition.topCoordinate),$(".jqm-mail-more-buttons-header a.move").click(function(){setTimeout(function(){$("#folder-selector").css({left:($(document).width()-$("#folder-selector").width())/2,top:50})},50)})}),$(document).on("click","#messagelist a",function(e){return e.preventDefault(),!1}),$(document).on("pageshow","#page_addressbook_list",function(){null!==window.storePosition.topCoordinate&&$.mobile.silentScroll(window.storePosition.topCoordinate)}),$(document).on("pageshow",".jqm-message",function(){if($("#buttons-right-panel a").click(function(){setTimeout(function(){$("#folder-selector").css({left:($(document).width()-$("#folder-selector").width())/2,top:50}),$("#buttons-right-panel").panel("close")},50)}),window.current_uid){$(".jqm_message_list_group").show(),$(".rc_message_back").hide();var e=rcmail.message_list.get_next_row(),t=rcmail.message_list.get_prev_row();e?$(".jqm_message_next").show():($(".jqm_message_next").hide(),load_next_page()),t?$(".jqm_message_previous").show():$(".jqm_message_previous").hide(),rcmail.env.uid=window.current_uid,rcmail.env.action="show",rcmail.env.messages[window.current_uid].flags&&jQuery.each(rcmail.env.messages[window.current_uid].flags.tb_labels,function(e,t){rcm_tb_label_flag_msgs([-1],t)}),$("#attachment-list li").length||($("div.rightcol").hide(),$("div.leftcol").css("margin-right","0")),$("#messagebody img").each(function(){if("program/resources/blocked.gif"==$(this).attr("src"))return $("#remote-objects-message").show(),void rcmail.enable_command("load-images","always-load",!0)}),rcmail.env.isenigma&&"#messagebody div.enigmaerror".length&&($("#messagebody div.enigmaerror").html($("#messagebody div.enigmaerror").html()+" "+rcmail.gettext("mobile.addenigmapass")),$("#messagebody div.enigmaerror").click(function(){rcmail.env.enigma_password_request?rcmail.enigma_password_request(rcmail.env.enigma_password_request):window.location.reload()}));var i=["show","reply","reply-all","reply-list","move","copy","delete","open","mark","edit","viewsource","print","load-attachment","download-attachment","show-headers","hide-headers","download","forward","forward-inline","forward-attachment","change-format"];rcmail.enable_command(i,rcmail.env.uid),$("#countcontrols").hide(),rcmail.addEventListener("responseafterlist",function(e){rcmail.message_list.get_next_row()&&$(".jqm_message_next").show()}),rcmail.addEventListener("actionafter",function(e){if("mark"==e.action){if("unread"==e.props)rcmail.set_message(rcmail.env.uid,"unread",!0);else{if("read"!=e.props)return;rcmail.set_message(rcmail.env.uid,"unread",!1)}"page_mail_list"!=$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))}}),rcmail.addEventListener("responseaftermove",function(e){window.previous_page="current_page","page_mail_list"!=$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&("page_mail_list"==window.previous_page?$.mobile.back():$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list")))}),rcmail.addEventListener("responseafterdelete",function(e){window.previous_page="current_page","page_mail_list"!=$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&("page_mail_list"==window.previous_page?$.mobile.back():$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list")))})}}),$(document).on("pagecreate",".jqm-message",function(){window.previous_page&&($(".jqm_message_list").click(function(e){"page_mail_list"==window.previous_page?(window.previous_page="current_page",$.mobile.back()):(window.previous_page="current_page",$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))),e.preventDefault()}),$(".jqm_message_previous").click(function(e){var t=rcmail.message_list.get_row_uid(rcmail.message_list.get_prev_row());window.current_uid=t,rcmail.message_list.last_selected=t,window.previous_page="current_page",rcmail.set_message(t,"unread",!1),rcmail.show_message_mobile(t,{}),window.storePosition.topCoordinate-=76,e.preventDefault()}),$(".jqm_message_next").click(function(e){var t=rcmail.message_list.get_row_uid(rcmail.message_list.get_next_row());window.current_uid=t,rcmail.message_list.last_selected=t,window.previous_page="current_page",rcmail.set_message(t,"unread",!1),rcmail.show_message_mobile(t,{}),window.storePosition.topCoordinate+=76,e.preventDefault()}),$("#attachment-list li a").click(function(){$(this).attr("target","_blank"),$(this).attr("onlick","")}),$(".image-attachment a").click(function(){$(this).attr("target","_blank"),$(this).attr("onlick","")}),$(".zipdownload").hide())}),$(document).on("pageshow",".jqm-contact",function(){window.current_uid&&($(".jqm_contact_list_group").show(),$(".rc_contact_back").hide(),rcmail.env.cid=window.current_uid,rcmail.env.action="show",rcmail.enable_command("show","edit",!0),$("input.groupmember").change(function(){rcmail.group_member_change(this.checked?"add":"del",rcmail.env.cid,rcmail.env.source,this.value)}))}),$(document).on("pagecreate",".jqm-contact",function(){if(window.previous_page){var e=!0;$(document).on("swipeleft swiperight",".jqm-contact",function(t){e&&(e=!1,setTimeout(function(){e=!0},900))}),$(".jqm_contact_list").click(function(e){"page_addressbook_list"==window.previous_page?(window.previous_page="current_page",$.mobile.back()):(window.previous_page="current_page",$.mobile.pageContainer.pagecontainer("change",$("#page_addressbook_list"))),e.preventDefault()}),$(".contactcontrollerphone .contactfieldcontent.text").each(function(){$(this).html('<a href="tel:'+$(this).html()+'">'+$(this).html()+"</a>")}),rcmail.register_command("delete_mobile",rcmail.delete_contact_mobile,!rcmail.env.readonly)}}),$(document).on("pageshow",".jqm-plugin",function(){$(".ui-button-disabled").removeClass("ui-button-disabled").removeClass("ui-state-disabled")}),$(document).on("pageshow",".jqm-enigma-key-import",function(){$(".ui-button-disabled").removeClass("ui-button-disabled").removeClass("ui-state-disabled")}),$(document).on("pageloadfailed",function(e,t){e.preventDefault()}),$(document).ready(function(){if($("#mailboxlist").attr("data-role","listview"),$("#mailboxlist ul").attr("data-role","listview"),$("#mailboxlist ul").show(),$("#mailboxlist li").attr("data-icon","false"),$("#mailboxlist div.treetoggle").hide(),rcmail.addEventListener("insertrow",function(e){add_mobile_class(e.uid,e.row)}),$("#quicksearchbox").attr("placeholder","Search..."),$("#quicksearchbox").attr("data-type","search"),$("#directorylist_mobile").attr("data-role","listview"),$("#directorylist_mobile ul").attr("data-role","listview"),$("#directorylist_mobile ul").show(),$("#directorylist_mobile > li").attr("data-icon","user"),$("#directorylist_mobile li li").attr("data-icon","false"),$("#directorylist_mobile div.treetoggle").hide(),$("#calendarslist").attr("data-role","listview"),$("#calendarslist ul").attr("data-role","listview"),$("#calendarslist div.treetoggle").hide(),$("#settingslist_mobile").attr("data-role","listview"),$("#settingslist_mobile a").attr("data-ajax","false"),$("#settingslist_mobile ul").attr("data-role","listview"),$("#settingslist_mobile ul").show(),$("#settingslist_mobile > li").attr("data-icon","user"),$("#settingslist_mobile li li").attr("data-icon","false"),$("#settingslist_mobile div.treetoggle").hide(),$("#subscription-table").attr("data-role","listview"),$("#subscription-table ul").attr("data-role","listview"),$("#subscription-table ul").show(),$("#subscription-table li").attr("data-icon","carat-r"),$("#subscription-table div.treetoggle").hide(),$("#eventedit").length&&$("#eventedit .edit-alarm-type").selectmenu(),$("#apps-right-panel .button-switch_desktop").length){e=$("#apps-right-panel .button-switch_desktop").get(0).outerHTML;$("#apps-right-panel .button-switch_desktop").remove(),$("#apps-right-panel .button-logout").before(e)}if($("#apps-right-panel .button-calendar").length){e=$("#apps-right-panel .button-calendar").get(0).outerHTML;$("#apps-right-panel .button-calendar").remove(),$("#apps-right-panel .button-settings").before(e)}if($("#apps-right-panel .button-melanie2_moncompte").length){e=$("#apps-right-panel .button-melanie2_moncompte").get(0).outerHTML;$("#apps-right-panel .button-melanie2_moncompte").remove(),$("#apps-right-panel .button-settings").before(e)}if($("#apps-right-panel .button-melanie2_sondage").length){e=$("#apps-right-panel .button-melanie2_sondage").get(0).outerHTML;$("#apps-right-panel .button-melanie2_sondage").remove(),$("#apps-right-panel .button-settings").before(e)}if($("#apps-right-panel .button-melanie2_jabber").length){var e=$("#apps-right-panel .button-melanie2_jabber").get(0).outerHTML;$("#apps-right-panel .button-melanie2_jabber").remove(),$("#apps-right-panel .button-settings").before(e)}}),$(document).bind("mobileinit",function(){$.mobile.page.prototype.options.domCache=!1,$.mobile.ajaxLinksEnabled=!1}),window.rcmail&&(rcmail.addEventListener("init",function(e){if(rcmail.env.isenigma&&(rcmail.enigma_password_request=function(e){if(e&&e.keyid){var t=this,i=this.get_label("enigma.enterkeypass"),a=$("<div>").attr({"data-role":"popup",id:"passwordrequestpopup","data-theme":"f",class:"ui-corner-all prompt"}),n=$("<form>").appendTo(a),o=$("<div>").attr({style:"padding:10px 20px;"}).appendTo(n),r=$("<h3>").appendTo(o),s=$("<input>").attr({name:"keypassword",id:"enigmakeypassword",type:"password"}).appendTo(o);$("<button>").attr({type:"submit","data-theme":"f","data-icon":"check"}).text(this.get_label("save")).appendTo(o);e.key=e.keyid,e.keyid.length>8&&(e.keyid=e.keyid.substr(e.keyid.length-8)),$.each(["keyid","user"],function(){i=i.replace("$"+this,e[this])}),r.text(i),n.submit(function(i){i.stopPropagation(),i.preventDefault(),e.password=$("#enigmakeypassword").val(),e.password?t.enigma_password_submit(e):$("#enigmakeypassword").focus()}),setTimeout(function(){a.popup(),a.trigger("create"),a.popup("open"),s.focus()},200)}},rcmail.enigma_password_submit=function(e){if("compose"==this.env.action&&!e["compose-init"])return this.enigma_password_compose_submit(e);var t=$("<form>").attr({method:"post",action:e.action||location.href,style:"display:none"}).append($("<input>").attr({type:"hidden",name:"_keyid",value:e.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:e.password})).append($("<input>").attr({type:"hidden",name:"_token",value:this.env.request_token}));if($.each(e,function(e,i){0==e.indexOf("input")&&t.append($("<input>").attr({type:"hidden",name:e.substring(5),value:i}))}),e.iframe){var i="enigma_frame_"+(new Date).getTime();$("<iframe>").attr({style:"display:none",name:i}).appendTo(document.body);t.attr("target",i)}t.appendTo(document.body).submit()}),window.page_loading={},window.current_page_scroll=1,$("#select_balp_mobile").change(function(){window.location=$("#select_balp_mobile option:selected").val()}),$("#select_balp_mobile").click(function(e){e.stopPropagation(),e.preventDefault()}),$("#messagessearchfilter").click(function(e){e.stopPropagation(),e.preventDefault()}),-1==window.location.href.indexOf("?_task=addressbook&_orig_source=")||rcmail.env.cid||(window.location="?_task=addressbook&_source="+window.location.href.split("?_task=addressbook&_orig_source=").pop()),"mail"!=rcmail.env.task||rcmail.env.action&&""!=rcmail.env.action)if("mail"==rcmail.env.task&&"compose"==rcmail.env.action){$(".button_upload_photo").click(function(){$("#upload-popup").popup("close")}),rcmail.env.compose_commands=["send-attachment","remove-attachment","send","cancel","toggle-editor","list-adresses","pushgroup","search","reset-search","extwin","insert-response","save-response"],rcmail.env.drafts_mailbox&&rcmail.env.compose_commands.push("savedraft"),rcmail.env.isenigma&&rcmail.env.compose_commands.push("menu-open"),rcmail.enable_command(rcmail.env.compose_commands,"identities","responses",!0),rcmail.addEventListener("aftersend-attachment",show_uploadform).addEventListener("add-recipient",function(e){show_header_row(e.field,!0)});var t,i,a,n=["cc","bcc","replyto","followupto"];for(t=0;t<n.length;t++)i=n[t],(a=$("#_"+i)).length&&(a.on("change",{v:i},function(e){this.value&&show_header_row(e.data.v,!0)}),""!=a.val()&&show_header_row(i,!0))}else"mail"==rcmail.env.task&&"show"==rcmail.env.action?($(".mark_as_read").click(function(){$("#buttons-right-panel").panel("close")}),$(".mark_as_unread").click(function(){$("#buttons-right-panel").panel("close")}),$("#bounce_button_mobile").click(function(){$("#buttons-right-panel").panel("close")})):"addressbook"!=rcmail.env.task||rcmail.env.action&&""!=rcmail.env.action?"addressbook"==rcmail.env.task&&"show"==rcmail.env.action?($(".contactcontrollerphone .contactfieldcontent.text").each(function(){$(this).html('<a href="tel:'+$(this).html()+'">'+$(this).html()+"</a>")}),rcmail.register_command("delete_mobile",rcmail.delete_contact_mobile,!rcmail.env.readonly)):"addressbook"==rcmail.env.task&&"edit"==rcmail.env.action?($("select.addfieldmenu").change(function(){$("#contacttabs").trigger("create")}),$(".button_upload_photo").click(function(){$("#upload-popup").popup("close")})):"calendar"==rcmail.env.task?($(window).resize(function(){$("#calendarview-left-panel").panel("close")}),$(window).hashchange(function(e){var t=e.originalEvent.oldURL.split("#").pop();if(t)switch(t){case"event_show_dialog":$("#eventshow:ui-dialog").dialog("close");break;case"event_edit_dialog":$("#eventeditdialog:ui-dialog").dialog("close");break;case"eventeditpage":$.mobile.pageContainer.pagecontainer("change","./?_task=calendar")}})):"settings"==rcmail.env.task&&"edit-folder"==rcmail.env.action?(rcmail.env.mailbox=rcmail.env.folder,rcmail.enable_command("delete-folder",!0)):"settings"==rcmail.env.task&&"plugin.managesieve-action"==rcmail.env.action?($(".boxcontent").trigger("create"),rcmail.addEventListener("responseafterplugin.managesieve-action",function(e){$(".boxcontent").trigger("create")})):"settings"==rcmail.env.task&&"plugin.managesieve"==rcmail.env.action?$(document).on("click","table#filterslist tr",function(){var e=rcmail.filters_list.get_row_uid($(this).get(0));window.location.href=rcmail.env.comm_path+"&_action=plugin.managesieve-action&_framed=1&_fid="+e}):"settings"==rcmail.env.task&&"plugin.enigmakeys"==rcmail.env.action&&($(document).on("tap","table#keys-table td",function(){var e=rcmail.keys_list.get_row_uid($(this).parent().get(0));window.location.href=rcmail.env.comm_path+"&_action=plugin.enigmakeys&_a=info&_id="+e}),$(document).on("click","#page_keys_list a.enigma-key-import",function(){window.location.href=rcmail.env.comm_path+"&_action=plugin.enigmakeys&_a=import"}),$(document).on("click","#page_keys_list a.enigma-key-create",function(){window.location.href=rcmail.env.comm_path+"&_action=plugin.enigmakeys&_a=create"}),$(document).on("click",".jqm-enigma-key-create a.enigma-key-delete",function(){var e=rcmail.display_message(rcmail.get_label("enigma.keyremoving"),"loading"),t={_a:"delete",_keys:[window.location.href.split("&_id=").pop()]};rcmail.http_post("plugin.enigmakeys",t,e)})):($(".ui-title").html($("#directorylist_mobile li.selected a").first().text()),$("#directorylist_mobile li.selected a").first().addClass("ui-btn ui-btn-icon-right ui-icon-check"),$(window).resize(function(){$("#addressbook-left-panel").panel("close")}),$("#directorylist_mobile li a").click(function(){$("#addressbook-left-panel").panel("close"),$("#directorylist_mobile li a").removeClass("ui-btn-active"),window.page_loading={},rcmail.env.current_page=1,$(".ui-title").html($(this).clone().children().remove().end().text()),$("#directorylist_mobile").listview("refresh")}),$(".jqm-addressbook-cancel-searchbox").click(function(){$(".jqm-addressbook-header").show(),$(".jqm-addressbook-search-header").hide()}),$(".jqm-addressbook-open-searchbox").click(function(){$(".jqm-addressbook-header").hide(),$(".jqm-addressbook-search-header").show(),$(".jqm-addressbook-search-header input").focus()}),$("#quicksearchbox").click(function(){$("#quicksearchbox").focus()}),$(window).scroll(function(){if($(window).scrollTop()>200&&($(window).scrollTop()+$(window).height())/$(document).height()>=.95){var e=rcmail.env.current_page+1;if(e>0&&e<=rcmail.env.pagecount&&!window.page_loading[e]){window.page_loading[e]=!0;var t=rcmail.set_busy(!0,"loading"),i={};i._source=rcmail.env.source,rcmail.env.group&&(i._gid=rcmail.env.group),i._page=e,rcmail.env.search_request&&(i._search=rcmail.env.search_request),rcmail.http_request_mobile("list",i,t,function(){rcmail.env.current_page=e},function(){})}}}),rcmail.contact_list.addEventListener("clear",function(e){window.page_loading={},rcmail.env.current_page=1}));else{$(".ui-title").html($("#mailboxlist li.selected a").first().clone().children().remove().end().text()),$(window).resize(function(){$("#mailview-left-panel").panel("close")}),$("#mailboxlist li a").click(function(){$("#mailview-left-panel").panel("close"),$(".ui-title").html($(this).clone().children().remove().end().text()),$("#mailboxlist").listview("refresh")}),$(".jqm-mail-cancel-searchbox").click(function(){$(".jqm-mail-header").show(),$(".jqm-mail-search-header").hide()}),$(".jqm-mail-open-searchbox").click(function(){$(".jqm-mail-header").hide(),$(".jqm-mail-search-header").show(),$(".jqm-mail-search-header input").focus()}),$(".jqm-mail-cancel-buttons").click(function(){$(".jqm-mail-header").show(),$(".jqm-mail-buttons-header").hide(),$(".jqm-mail-buttons-showmore").addClass("ui-icon-caret-down"),$(".jqm-mail-buttons-showmore").removeClass("ui-icon-caret-up"),$(".jqm-mail-more-buttons-header").hide(),rcmail.message_list.clear_selection()}),$(".jqm-mail-buttons-showmore").click(function(){$(this).hasClass("ui-icon-caret-down")?($(this).removeClass("ui-icon-caret-down"),$(this).addClass("ui-icon-caret-up"),$(".jqm-mail-more-buttons-header").show()):($(this).addClass("ui-icon-caret-down"),$(this).removeClass("ui-icon-caret-up"),$(".jqm-mail-more-buttons-header").hide())}),$(".jqm-mail-more-buttons-header li").each(function(){$(this).find("a").hasClass("filterlink")&&($(this).find("a").addClass("ui-link ui-btn ui-corner-all ui-icon-filter ui-btn-icon-notext"),$(".jqm-mail-more-buttons-header .ui-controlgroup-controls .move").before($(this).html())),$(this).remove()}),$(document).on("click",".jqm-mail-more-buttons-header a.filterlink",function(){window.location.href=rcmail.env.comm_path+"&_action=plugin.managesieve-action&_framed=1"}),$("#quicksearchbox").click(function(){$("#quicksearchbox").focus()}),$(document).scroll(function(){"page_mail_list"==$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&$(window).scrollTop()>200&&($(window).scrollTop()+$(window).height())/$(document).height()>=.95&&window.current_page_scroll>1&&load_next_page()}),rcmail.message_list.addEventListener("clear",function(e){window.page_loading={},rcmail.env.current_page=1,window.current_page_scroll=2})}if(rcmail.message_list){o=window.rcmail;rcmail.message_list.addEventListener("click",function(e){return!1}).addEventListener("dblclick",function(e){return!1}).addEventListener("keypress",function(e){return!1}).addEventListener("select",function(e){return!1}).addEventListener("dragstart",function(e){return!1}).addEventListener("dragmove",function(e){return!1}).addEventListener("dragend",function(e){return!1}).addEventListener("expandcollapse",function(e){return!1}).addEventListener("column_replace",function(e){return!1}),rcmail&&rcube_list_widget&&(rcube_list_widget.prototype.drag_row=function(e,t){if(!this.is_event_target(e))return!0;if(this.drag_active=!1,this.in_selection_before=!!(e&&e.istouch||this.in_selection(t))&&t,!this.in_selection_before){var i=rcube_event.get_modifier(e);this.select_row(t,i,!0)}return!1},rcube_list_widget.prototype.select_row=function(e,t,i,a){var n=this.selection.join(","),o=this.in_selection(e);this.last_selected&&this.rows[this.last_selected]&&$(this.rows[this.last_selected].obj).removeClass("focused").find(this.col_tagname()).eq(this.subject_col).removeAttr("tabindex"),this.toggleselect&&o&&!t?this.clear_selection():this.selection.join(",")!=n&&this.triggerEvent("select"),this.rows[e]&&($(this.rows[e].obj).addClass("focused"),this.focused&&this.focus_noscroll($(this.rows[e].obj).find(this.col_tagname()).eq(this.subject_col).attr("tabindex","0"))),this.selection.length||(this.shift_start=null),this.last_selected=e},rcube_list_widget.prototype.click_row=function(e,t){var i=rcube_event.get_mouse_pos(e),a=$("#mailview-left-panel").position().left+272;return i.x-a>50?(this.highlight_row(t,!1),this.multi_selecting=!1,window.clearTimeout(window.show_timer),window.storePosition.topCoordinate=$(window).scrollTop(),window.previous_page="page_mail_list",this.clear_selection(),window.current_uid=t,this.last_selected=t,rcmail.set_message(t,"unread",!1),t&&rcmail.env.mailbox==rcmail.env.drafts_mailbox?rcmail.open_compose_step({_draft_uid:t,_mbox:rcmail.env.mailbox}):rcmail.show_message_mobile(t,{})):(this.selection.length||delete rcmail.env.uid,this.highlight_row(t,!0),this.multi_selecting=!0,rcmail.enable_command("delete","move","copy","mark","reply","forward",this.selection.length>0),this.selection.length?($(".jqm-mail-header").hide(),$(".jqm-mail-buttons-header").show(),this.selection.length>1?($(".jqm-mail-buttons-header .reply").hide(),$(".jqm-mail-buttons-header .forward").hide(),$(".jqm-mail-more-buttons-header .filterlink").hide(),$(".jqm-mail-more-buttons-header .reply-all").hide()):($(".jqm-mail-buttons-header .reply").show(),$(".jqm-mail-buttons-header .forward").show(),$(".jqm-mail-more-buttons-header .filterlink").show(),$(".jqm-mail-more-buttons-header .reply-all").show())):($(".jqm-mail-header").show(),$(".jqm-mail-buttons-header").hide(),$(".jqm-mail-buttons-showmore").addClass("ui-icon-caret-down"),$(".jqm-mail-buttons-showmore").removeClass("ui-icon-caret-up"),$(".jqm-mail-more-buttons-header").hide())),this.drag_start=!1,this.in_selection_before=!1,this.focus(),!1})}if(rcmail.contact_list){var o=window.rcmail;rcmail.contact_list.addEventListener("click",function(e){window.previous_page="page_addressbook_list",window.storePosition.topCoordinate=$(window).scrollTop(),o.contactlist_select_mobile(e)}).addEventListener("dragstart",function(e){return!1}).addEventListener("dragmove",function(e){return!1}).addEventListener("dragend",function(e){return!1})}}),rcmail.addEventListener("responseafterlist",function(e){window.current_page_scroll=rcmail.env.current_page+1,rcmail.env.current_page=1,rcmail.http_post("mobile.set_current_page",{})})),rcube_webmail.prototype.http_request_mobile=function(e,t,i,a,n){var o=this.url(e,t),r=this,s=this.triggerEvent("request"+e,t);if(void 0!==s){if(!1===s)return!1;o=this.url(e,s)}return o+="&_remote=1",this.log("HTTP GET: "+o),this.start_keepalive(),$.ajax({type:"GET",url:o,data:{_unlock:i||0},dataType:"json",success:function(e){r.http_response(e),a()},error:function(t,a,o){r.http_error(t,a,o,i,e),n()}})},rcube_webmail.prototype.delete_contact_mobile=function(){if(!rcmail.env.readonly&&confirm(rcmail.get_label("deletecontactconfirm"))){return post_data={},post_data._source=rcmail.env.source,post_data._from=rcmail.env.action,post_data._cid=rcmail.env.cid,lock=rcmail.display_message(rcmail.get_label("contactdeleting"),"loading"),rcmail.env.group&&(post_data._gid=rcmail.env.group),rcmail.env.search_request&&(post_data._search=rcmail.env.search_request),rcmail.http_post("delete",post_data,lock),window.location="?_task="+rcmail.env.task+"&_source="+rcmail.env.source,!0}},rcube_webmail.prototype.msglist_dbl_click_mobile=function(e){this.preview_timer&&clearTimeout(this.preview_timer),this.preview_read_timer&&clearTimeout(this.preview_read_timer);var t=e.get_single_selection();e.clear_selection(),window.current_uid=t,this.set_message(t,"unread",!1),t&&this.env.mailbox==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:t,_mbox:this.env.mailbox}):t&&this.show_message_mobile(t,{})},rcube_webmail.prototype.show_message_mobile=function(e,t){if(e){$("#messagelist li").removeClass("selected"),$("#messagelist li#rcmrow"+e).addClass("selected");window;var i="&_action=show&_uid="+e+"&_mbox="+urlencode(this.env.mailbox);this.env.search_request&&(i+="&_search="+this.env.search_request),i+="&_caps="+urlencode(this.browser_capabilities()),this.env.extwin&&(i+="&_extwin=1"),$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+i,t)}},rcube_webmail.prototype.contactlist_select_mobile=function(e){this.preview_timer&&clearTimeout(this.preview_timer);var t,i=this;this.env.source&&this.env.address_sources[this.env.source];return(t=e.get_single_selection())&&i.load_contact_mobile(t,"show"),window.current_uid=t,this.enable_command("group-remove-selected",this.env.group&&e.selection.length>0&&!1),this.enable_command("compose",this.env.group||e.selection.length>0),this.enable_command("export-selected","copy",e.selection.length>0),this.enable_command("edit",t&&!1),this.enable_command("delete","move",e.selection.length>0&&!1),!1},rcube_webmail.prototype.load_contact_mobile=function(e,t,i){var a="";window,this.contact_list&&this.contact_list.data[e];return!t||!e&&"add"!=t||this.drag_active||($("#contacts-table tr").removeClass("selected"),$("#contacts-table tr#rcmrow"+e).addClass("selected"),a="&_action="+t,this.env.search_request&&(a+="&_search="+this.env.search_request),a+="&_source="+this.env.source,a+="&_cid="+e,$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+a,{})),!0},rcube_webmail.prototype.managesieve_add=function(){alert("managesieve_add"),this.load_managesieveframe(),this.filters_list.clear_selection()},rcube_webmail.prototype.load_managesieveframe=function(e){var t=void 0!==e&&null!=e;this.enable_command("plugin.managesieve-act","plugin.managesieve-del",t);var i=this.set_busy(!0,"loading");$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+"&_action=plugin.managesieve-action&_framed=1"+(t?"&_fid="+e:"")+"&_unlock="+i,{})};var compose_headers={};